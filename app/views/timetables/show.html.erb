<h2>Timetable</h2>

<%= form_tag({controller => :timetables, :action => :show}, :method => :get) do %>
<fieldset><legend><%= l(:label_filter_plural) %></legend>
<label for='status'><%= l(:field_status) %>:</label>
<%= select_tag 'status', users_status_options_for_select(@status), :class => "small", :onchange => "this.form.submit(); return false;"  %>

<% if @groups.present? %>
<label for='group_id'><%= l(:label_group) %>:</label>
<%= select_tag 'group_id', content_tag('option') + options_from_collection_for_select(@groups, :id, :name, params[:group_id].to_i), :onchange => "this.form.submit(); return false;"  %>
<% end %>

<label for='name'><%= l(:label_user) %>:</label>
<%= text_field_tag 'name', params[:name], :size => 30 %>
<%= submit_tag l(:button_apply), :class => "small", :name => nil %>
<%= link_to l(:button_clear), {controller => :timetables, :action => :show}, :class => 'icon icon-reload' %>
</fieldset>
<% end %>
&nbsp;

<% usernames = @users.collect{|u| u.firstname + " " + u.lastname } %>
<%= usernames.join(";") %>
<br>
<div class="autoscroll">
<table class="list">
  <tbody>
<% for user in @users -%>
  <tr class="<%= user.css_classes %> <%= cycle("odd", "even") %>">
  <td class="username"><%= avatar(user, :size => "14") %><%= link_to h(user.login), edit_user_path(user) %></td>
  <td class="firstname"><%= h(user.firstname) %></td>
  <td class="lastname"><%= h(user.lastname) %></td>
<table class="list">
  <tbody>
  <% for i in issues_for_user(user.id) -%>
    <tr> <%= i.id %> <%=i.start_date %>; </tr>
  <% end -%>
  </tbody>
  </tr>
<% end -%>
  </tbody>
</table>

<div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:500px;padding:5px;'>
    <div class="dhx_cal_navline">
        <div class="dhx_cal_prev_button">&nbsp;</div>
        <div class="dhx_cal_next_button">&nbsp;</div>
        <div class="dhx_cal_today_button"></div>
        <div class="dhx_cal_date"></div>
    </div>
    <div class="dhx_cal_header"></div>
    <div class="dhx_cal_data"></div>       
</div>


<% html_title("Timetable") -%>

<script type="text/javascript" charset="utf-8" >
function init(){
		var sections=[
                        <% usernames.each_with_index do |un,i|  %>
                           <%= raw "{key:#{i}, label:\'#{un}\'},\n" %>
                        <% end %>
		];
		
		scheduler.createTimelineView({
			name:	"timeline",
			x_unit:	"day",
			x_date:	"%M %d",
			x_step:	1,
			x_size: 30,
                        dy: 25,
			y_unit:	sections,
			y_property:	"section_id",
			render:"bar",
                        section_autoheight:"false",
		});
		
scheduler.init('scheduler_here', new Date(),"timeline");
		scheduler.parse([
			{ start_date: "2012-08-30 09:00", end_date: "2012-08-30 12:00", text:"Task A-12458", section_id:1},
			{ start_date: "2012-08-30 10:00", end_date: "2012-08-30 16:00", text:"Task A-89411", section_id:1},
			{ start_date: "2012-08-30 10:00", end_date: "2012-08-30 14:00", text:"Task A-64168", section_id:1},
			{ start_date: "2012-08-30 16:00", end_date: "2012-08-30 17:00", text:"Task A-46598", section_id:1},
			
			{ start_date: "2012-08-30 12:00", end_date: "2012-08-30 20:00", text:"Task B-48865", section_id:2},
			{ start_date: "2012-08-30 14:00", end_date: "2012-08-30 16:00", text:"Task B-44864", section_id:2},
			{ start_date: "2012-08-30 16:30", end_date: "2012-08-30 18:00", text:"Task B-46558", section_id:2},
			{ start_date: "2012-08-30 18:30", end_date: "2012-08-30 20:00", text:"Task B-45564", section_id:2},
			
			{ start_date: "2012-08-30 08:00", end_date: "2012-08-30 12:00", text:"Task C-32421", section_id:3},
			{ start_date: "2012-08-30 14:30", end_date: "2012-08-30 16:45", text:"Task C-14244", section_id:3},
			
			{ start_date: "2012-08-30 09:20", end_date: "2012-08-30 12:20", text:"Task D-52688", section_id:4},
			{ start_date: "2012-08-30 11:40", end_date: "2012-08-30 16:30", text:"Task D-46588", section_id:4},
			{ start_date: "2012-08-30 12:00", end_date: "2012-08-30 18:00", text:"Task D-12458", section_id:4}
		],"json");
//var events = [
//{id:1, text:"Meeting",   start_date:"04/11/2013 14:00",end_date:"04/11/2013 17:00"},
//{id:2, text:"Conference",start_date:"04/15/2013 12:00",end_date:"04/18/2013 19:00"},
//{id:3, text:"Interview", start_date:"04/24/2013 09:00",end_date:"04/24/2013 10:00"}
//];
 
//scheduler.parse("events", "json");//takes the name and format of the data source
}
</script>

<% content_for :header_tags do %>
    <%= javascript_include_tag 'dhtmlxscheduler', :plugin => 'redmine_timetables' %>
    <%= javascript_include_tag 'ext/dhtmlxscheduler_timeline', :plugin => 'redmine_timetables' %>
    <%= stylesheet_link_tag 'dhtmlxscheduler', :plugin => 'redmine_timetables' %>
<% end %>

